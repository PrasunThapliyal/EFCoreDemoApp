CREATE TABLE IF NOT EXISTS "__EFMigrationsHistory" (
    "MigrationId" TEXT NOT NULL CONSTRAINT "PK___EFMigrationsHistory" PRIMARY KEY,
    "ProductVersion" TEXT NOT NULL
);

BEGIN TRANSACTION;

CREATE TABLE "Authors" (
    "AuthorId" INTEGER NOT NULL CONSTRAINT "PK_Authors" PRIMARY KEY AUTOINCREMENT,
    "Name" TEXT NULL
);

CREATE TABLE "Books" (
    "BookId" INTEGER NOT NULL CONSTRAINT "PK_Books" PRIMARY KEY AUTOINCREMENT,
    "Title" TEXT NULL,
    "AuthorId" INTEGER NOT NULL,
    CONSTRAINT "FK_Books_Authors_AuthorId" FOREIGN KEY ("AuthorId") REFERENCES "Authors" ("AuthorId") ON DELETE CASCADE
);

CREATE INDEX "IX_Books_AuthorId" ON "Books" ("AuthorId");

INSERT INTO "__EFMigrationsHistory" ("MigrationId", "ProductVersion")
VALUES ('20260112101335_InitialCreate', '8.0.22');

COMMIT;

BEGIN TRANSACTION;

ALTER TABLE "Books" ADD "BookStoreId" INTEGER NOT NULL DEFAULT 0;

ALTER TABLE "Authors" ADD "BookStoreId" INTEGER NOT NULL DEFAULT 0;

CREATE TABLE "BookStores" (
    "BookStoreId" INTEGER NOT NULL CONSTRAINT "PK_BookStores" PRIMARY KEY AUTOINCREMENT,
    "Name" TEXT NULL
);

CREATE INDEX "IX_Books_BookStoreId" ON "Books" ("BookStoreId");

CREATE INDEX "IX_Authors_BookStoreId" ON "Authors" ("BookStoreId");

CREATE TABLE "ef_temp_Authors" (
    "AuthorId" INTEGER NOT NULL CONSTRAINT "PK_Authors" PRIMARY KEY AUTOINCREMENT,
    "BookStoreId" INTEGER NOT NULL,
    "Name" TEXT NULL,
    CONSTRAINT "FK_Authors_BookStores_BookStoreId" FOREIGN KEY ("BookStoreId") REFERENCES "BookStores" ("BookStoreId") ON DELETE CASCADE
);

INSERT INTO "ef_temp_Authors" ("AuthorId", "BookStoreId", "Name")
SELECT "AuthorId", "BookStoreId", "Name"
FROM "Authors";

CREATE TABLE "ef_temp_Books" (
    "BookId" INTEGER NOT NULL CONSTRAINT "PK_Books" PRIMARY KEY AUTOINCREMENT,
    "AuthorId" INTEGER NOT NULL,
    "BookStoreId" INTEGER NOT NULL,
    "Title" TEXT NULL,
    CONSTRAINT "FK_Books_Authors_AuthorId" FOREIGN KEY ("AuthorId") REFERENCES "Authors" ("AuthorId") ON DELETE CASCADE,
    CONSTRAINT "FK_Books_BookStores_BookStoreId" FOREIGN KEY ("BookStoreId") REFERENCES "BookStores" ("BookStoreId") ON DELETE CASCADE
);

INSERT INTO "ef_temp_Books" ("BookId", "AuthorId", "BookStoreId", "Title")
SELECT "BookId", "AuthorId", "BookStoreId", "Title"
FROM "Books";

COMMIT;

PRAGMA foreign_keys = 0;

BEGIN TRANSACTION;

DROP TABLE "Authors";

ALTER TABLE "ef_temp_Authors" RENAME TO "Authors";

DROP TABLE "Books";

ALTER TABLE "ef_temp_Books" RENAME TO "Books";

COMMIT;

PRAGMA foreign_keys = 1;

BEGIN TRANSACTION;

CREATE INDEX "IX_Authors_BookStoreId" ON "Authors" ("BookStoreId");

CREATE INDEX "IX_Books_AuthorId" ON "Books" ("AuthorId");

CREATE INDEX "IX_Books_BookStoreId" ON "Books" ("BookStoreId");

INSERT INTO "__EFMigrationsHistory" ("MigrationId", "ProductVersion")
VALUES ('20260113060424_AddBookStoreTable', '8.0.22');

COMMIT;

